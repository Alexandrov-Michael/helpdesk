<!DOCTYPE html>
<html>
<head>
    {% include 'head_links.html' %}
    <title>
    {% block title %}
        Главная
    {% endblock %}
     | ФРЕГАТСОФТ
    </title>
    {% block links %}
    {% endblock %}
    {% block head_script %}
    {% endblock %}
</head>
<body>
{% include 'ie-block.html' %}
<div id='wropper'>
    <div id='header'>
        <div id='headerTop'>
            <div id='menu'>
                {% include "menu.html" %}
                <div id="message_wrop"></div>
            </div>
        </div><!--headerTop-->
        <div id='headerBot'>
            <div id="loading_wrop">
                <div id="loading"></div>
            </div>
            <div id="admin_face_main">
                {% if user_image %}
                    <img src="{{user_image.url }}" width="70" height="70">
                {% endif %}
            </div>
        </div><!--headerBot-->
        <div id="accounting"></div>
    </div><!--header-->
    <div class='container-fluid' id="main">
            {% block content %}
                <div class='messages'>
                    {% if company_admins %}
                        <h2>Сопровождающие специалисты:</h2>
                            <div class='admins_list'>
                                <table id="curators_main">
                                    <tbody>
                                        {% for item in company_admins %}
                                            <tr>
                                                <td><a href="/add_q/?user={{ item.username.id }}&post={{ item.post.id }}">{{ item.post.decription }}</a></td>
                                                <td><a href="/add_q/?user={{ item.username.id }}&post={{ item.post.id }}">{{ item.username.first_name }} {{ item.username.last_name }}</a></td>
                                                <td>{{ item.username.profile.telefon }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                    {% endif %}
                </div>
            <h2>Список обращений</h2>
            <div id='tableDivWrop'>
                {% include 'question_table.html' %} 
            </div>
            {% endblock %}
    </div><!--content-->
    <div id='footer'>
        {% block footer %}
        {% endblock %}
    </div><!--footer-->
</div><!--wropper-->
<script type="text/javascript">
    function ShowMessage()
    {
        var text_message = '{{ success_message }}';
        var error_class = '{% if is_error_message %}1{% endif %}';
        var div_message = $('#message_wrop');
        if(text_message)
        {
            if(error_class == 1)
            {
                AddMessageError(text_message);
            }else{
                div_message.append('<div class="alert alert-info">'+text_message+'</div>');
                var mess = $('div:last-child',div_message);
                mess.fadeIn();
                setTimeout(function(){
                    mess.fadeOut('slow');
                }, 3500);
            }
        }
    }
    function AddMessageError(text)
    {
        var message = $('#message_wrop');
        message.append('<div class="alert alert-error">'+text+'</div>');
        var err_mess = $('div:last-child',message);
        err_mess.fadeIn();
        setTimeout(function(){
            err_mess.fadeOut('slow');
        }, 3500);
    }
    function AddSuccessMessage(text)
    {
        var message = $('#message_wrop');
        message.append('<div class="alert alert-success">'+text+'</div>');
        var err_mess = $('div:last-child',message);
        err_mess.fadeIn();
        setTimeout(function(){
            err_mess.fadeOut('slow');
        }, 3500);
    }
    function CountObjectProperty(data)
    {
        var count = 0;
        for (var foo in data) {
            if(data.hasOwnProperty(foo))
            {
                count++;
            }
        }
        return count;
    }
    function getUrlVars()
    {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }
    function GetMonth(number)
    {
        var mount = {
            1 : 'январь',
            2 : 'февраль',
            3 : 'март',
            4 : 'апрель',
            5 : 'май',
            6 : 'июнь',
            7 : 'июль',
            8 : 'август',
            9 : 'сентябрь',
            10 : 'октябрь',
            11 : 'ноябрь',
            12 : 'декабрь'
        };
        return mount[number];
    }
    $(document).ready(function(){
        ShowMessage();
    });
</script>
{% block script %}
    <script>
        function GetAccounting()
        {
            var company = '{{ user_is_company }}';
            var loading = $('#loading');
            var accounting = $('#accounting');
            loading.fadeIn();
            $.ajax({
                url: '/ajax/get_accounting_debts/',
                type: 'GET',
                dataType: 'json',
                success: function(data){
                    var counter = CountObjectProperty(data);
                    if(counter != 0)
                    {
                        accounting.append('<ul>');
                        $.each(data, function(id, value){
                            if(company == 'True')
                            {
                                accounting.append('<li>У вас неоплаченная задолжность за '+GetMonth(value["month"])+'</li>')
                            }
                            if(company == 'False')
                            {
                                accounting.append('<li>У фирмы '+value["company"]+' неоплаченная задолжность за '+GetMonth(value["month"])+' '+value["year"]+' по договору '+value["contract"]+'</li>')
                            }
                        });
                        accounting.append('</ul>');
                    }
                    loading.fadeOut();
                }
            });
        }

        function GetQues()
        {
            $('tbody').on ('click', 'tr',function(){
                var id = $(this).attr('id');
                if(id)
                {
                    window.location = '/chat/' + id;
                }
            })
        }
        $(document).ready(function(){
            GetAccounting();
            GetQues();
        });
    </script>
{% endblock %}
<script src="{{ MEDIA_URL }}js/bootstrap.min.js"></script>
</body>
</html>
